<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>Page Title</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <link rel='stylesheet' type='text/css' media='screen' href='main.css'>
</head>

<body>

    <div class="syntax-input-wrapper" contenteditable="true">
        <color on color="red">asdasdasd</color>asdasdasd
    </div>

    <style>
        .syntax-input-wrapper .unknown {
            color: red;
        }

        .syntax-input-wrapper .known {
            text-decoration: underline 2px;
        }

        .syntax-input-wrapper .hello {
            color: yellow;
        }

        .syntax-input-wrapper .hallo2 {
            color: green;
        }
    </style>

    <script>

        const element = document.querySelector(".syntax-input-wrapper");

        element.addEventListener("input", (e) => {
            const value = element.innerText;
            let htmlValue = value;
            const matches = new Set(value.match(/{([^ }{,]*)}/g));
            for (const match of matches) {
                htmlValue = htmlValue.replaceAll(match, getHtmlFor(match))
            }
            const cursorPosition = getCaretCharacterOffsetWithin(element);
            console.log(cursorPosition);
            element.innerHTML = htmlValue;
            setCaretAtPosition(element, cursorPosition);
        });

        function getHtmlFor(match) {
            if (match == "{Hallo}") return `<color class='hallo known'>${match}</color>`;
            if (match == "{Hallo2}") return `<color class='hallo2 known'>${match}</color>`;
            return `<color class='unknown'>${match}</color>`;
        }

        function getCaretCharacterOffsetWithin(element) {
            const selection = window.getSelection();
            if (!selection || selection.rangeCount === 0) return 0;

            const range = selection.getRangeAt(0).cloneRange();
            // Range von Anfang des Elements bis zur Cursor-Position
            const preRange = document.createRange();
            preRange.selectNodeContents(element);
            preRange.setEnd(range.endContainer, range.endOffset);

            return preRange.toString().length;
        }

        function setCaretAtPosition(el, charIndex) {
            const range = document.createRange();
            const sel = window.getSelection();

            let nodeStack = [el];
            let foundStart = false;
            let charCount = 0;
            let node;

            while (!foundStart && (node = nodeStack.pop())) {
                if (node.nodeType === 3) { // Text node
                    const nextCount = charCount + node.length;
                    if (charIndex >= charCount && charIndex <= nextCount) {
                        range.setStart(node, charIndex - charCount);
                        range.collapse(true);
                        foundStart = true;
                        break;
                    }
                    charCount = nextCount;
                } else {
                    let i = node.childNodes.length;
                    while (i--) nodeStack.push(node.childNodes[i]);
                }
            }

            if (!foundStart) range.selectNodeContents(el); // fallback
            sel.removeAllRanges();
            sel.addRange(range);
        }

    </script>

</body>

</html>